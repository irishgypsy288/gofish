#include "GameEngine.h"
#include <algorithm>
#include <random>
#include <iostream>

bool operator<(const Card& a, const Card& b) {
    if (a.rank != b.rank) return a.rank < b.rank;
    return a.suit < b.suit;
}

GameEngine::GameEngine() 
    : m_books1(0), m_books2(0), m_turn("AI1"), m_gameState(GameState::NOT_STARTED) {
    m_deniedRanks["AI1"] = {};
    m_deniedRanks["AI2"] = {};
}

GameEngine::~GameEngine() {
}

void GameEngine::startNewGame() {
    reset();
    initializeDeck();
    dealCards();
    
    // Check for initial books
    m_books1 += checkBooks(m_hand1);
    m_books2 += checkBooks(m_hand2);
    
    m_gameState = GameState::PLAYING;
    m_turn = "AI1";
    
    GameEvent event;
    event.type = EventType::GAME_STARTED;
    event.message = "New game started!";
    emitEvent(event);
}

void GameEngine::reset() {
    m_hand1.clear();
    m_hand2.clear();
    m_drawPile.clear();
    m_books1 = 0;
    m_books2 = 0;
    m_turn = "AI1";
    m_winner = "";
    m_gameState = GameState::NOT_STARTED;
    m_deniedRanks["AI1"].clear();
    m_deniedRanks["AI2"].clear();
    m_eventHistory.clear();
}

void GameEngine::initializeDeck() {
    std::vector<Card> deck;
    for (int suit = 0; suit < 4; ++suit) {
        for (int rank = 1; rank <= 13; ++rank) {
            deck.push_back({rank, suit});
        }
    }
    
    std::random_device rd;
    std::mt19937 g(rd());
    std::shuffle(deck.begin(), deck.end(), g);
    
    m_drawPile = deck;
}

void GameEngine::dealCards() {
    // Deal 7 cards to each player
    m_hand1.assign(m_drawPile.begin(), m_drawPile.begin() + 7);
    m_hand2.assign(m_drawPile.begin() + 7, m_drawPile.begin() + 14);
    m_drawPile.erase(m_drawPile.begin(), m_drawPile.begin() + 14);
    
    std::sort(m_hand1.begin(), m_hand1.end());
    std::sort(m_hand2.begin(), m_hand2.end());
}

int GameEngine::checkBooks(std::vector<Card>& hand) {
    int newBooks = 0;
    for (int r = 1; r <= 13; ++r) {
        if (countCards(hand, r) == 4) {
            // Remove the 4 cards of rank r
            hand.erase(std::remove_if(hand.begin(), hand.end(), 
                [r](const Card& c) { return c.rank == r; }), hand.end());
            ++newBooks;
            
            GameEvent event;
            event.type = EventType::BOOK_FORMED;
            event.rank = r;
            event.message = "Book of " + pluralRank(r) + " formed!";
            emitEvent(event);
        }
    }
    std::sort(hand.begin(), hand.end());
    return newBooks;
}

int GameEngine::countCards(const std::vector<Card>& hand, int rank) const {
    int count = 0;
    for (const auto& c : hand) {
        if (c.rank == rank) ++count;
